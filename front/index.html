<!DOCTYPE html>
<html lang="fr">

<head>
	<meta charset="UTF-8">
	<title>SGBD</title>
	<!-- Jquery-->
	<script language="javascript" type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<!-- Bootstrap -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Datatables -->
	<link href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
	<script language="javascript" type="text/javascript"
		src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>

</head>

<body class="mx-4">
	<div>
		<h1>Getter</h1>

		<div id="editionContainer">

		</div>

		<div class="mb-3">
			<button onclick="getApi('adherent')">Adherent</button>
			<button onclick="getApi('commune')">Communes</button>
			<button onclick="getApi('emprunt')">Emprunt</button>
			<button onclick="getApi('station')">Station</button>
			<button onclick="getApi('velo')">Velo</button>
			<button onclick="send()">Test procedure</button>
		</div>

		<table id="tableGetResults">
			<thead>
				<tr id="apiResultHead">
					<th scope="col">NOM</th>
					<th scope="col">ADRESSE</th>
					<th scope="col">COMMUNE</th>
					<th scope="col">DATE_ADHESION</th>
					<th scope="col">ID_ADHERENT</th>
				</tr>
			</thead>
			<tbody id="apiResultBody">
			</tbody>
		</table>
	</div>


	<div>
		<h1>Stats</h1>
		<button onclick="postApi('commune')">Ajouter une commune </button>
	</div>


	<div>
		<h1>Ajouter</h1>


		<select id="baseSelect" class="mb-3">
			<option value="emprunt">Emprunt</option>
			<option value="velo">Vélo</option>
			<option value="station">Station</option>
			<option value="adherent">Adherent</option>
			<option value="etat">Etat</option>
			<option value="commune">Commune</option>
		</select>

		<div id="addInputs" class="d-flex flex-wrap">
			<div class="mb-3 me-2">
				<label class="form-label">Kilometrage de départ</label>
				<input type="text" id="add_kilometrage_depart">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Heure de départ</label>
				<input type="text" id="add_heure_depart">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Heure de rendu</label>
				<input type="text" id="add_heure_rendu">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Id d'ahdérent</label>
				<input type="text" id="add_id_adherent">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Id de station</label>
				<input type="text" id="add_id_station">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Id de vélo</label>
				<input type="text" id="add_id_velo">
			</div>
		</div>
		<button onclick="add()">Ajouter</button>
	</div>

	<script>

		let table;

		$(document).ready(function () {
			table = $('#tableGetResults').DataTable();
			getApi('adherent');
			document.getElementById("baseSelect").addEventListener("change", baseSelectUpdater);
		});

		// ##### POST #####
		function baseSelectUpdater() {

			$('#addInputs').empty();

			// TODO : fix inputs types
			switch ($('#baseSelect').val()) {
				case "emprunt":
					$('#addInputs').append(`
			<div class="mb-3 me-2">
				<label class="form-label">Kilometrage de départ</label>
				<input type="text" id="add_kilometrage_depart">
			</div>
			
			<div class="mb-3 me-2">
				<label class="form-label">Heure de départ</label>
				<input type="text" id="add_heure_depart">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Heure de rendu</label>
				<input type="text" id="add_heure_rendu">
			</div>
			
			<div class="mb-3 me-2">
				<label class="form-label">Id d'ahdérent</label>
				<input type="text" id="add_id_adherent">
			</div>
			
			<div class="mb-3 me-2">
				<label class="form-label">Id de station</label>
				<input type="text" id="add_id_station">
			</div>
			
			<div class="mb-3 me-2">
				<label class="form-label">Id de vélo</label>
				<input type="text" id="add_id_velo">
			</div>`);
					break;

				case "velo":
					$('#addInputs').append(`
			<div class="mb-3 me-2">
				<label class="form-label">Marque</label>
				<input type="text" id="add_marque">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Date mise en service</label>
				<input type="text" id="add_edate_mise_en_service">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Kilometrage</label>
				<input type="text" id="add_kilometrage">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">État</label>
				<input type="text" id="add_etat">
			</div>
			<div class="mb-3 me-2">
				<label class="form-label">Niveau de batterie</label>
				<input type="text" id="add_niveau_batterie">
			</div>
			<div class="mb-3 me-2">
				<label class="form-label">Id de station</label>
				<input type="text" id="add_id_station">
			</div>
		`);
					break;

				case "station":
					$('#addInputs').append(`
			<div class="mb-3 me-2">
				<label class="form-label">Adresse</label>
				<input type="text" id="add_adresse">
			</div>
			
			<div class="mb-3 me-2">
				<label class="form-label">Commune</label>
				<input type="text" id="add_commune">
			</div>
			
			<div class="mb-3 me-2">
				<label class="form-label">Nombre de bornes</label>
				<input type="text" id="add_nb_bornes">
			</div>
			
			<div class="mb-3 me-2">
				<label class="form-label">Bornes disponibles</label>
				<input type="text" id="add_nb_bornes_dispo">
			</div>`);
					break;

				case "adherent":
					$('#addInputs').append(`
			<div class="mb-3 me-2">
				<label class="form-label">Nom</label>
				<input type="text" id="add_nom">
			</div>
			
			<div class="mb-3 me-2">
				<label class="form-label">Adresse</label>
				<input type="text" id="add_adresse">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Commune</label>
				<input type="text" id="add_commune">
			</div>

			<div class="mb-3 me-2">
				<label class="form-label">Date d'adhesion</label>
				<input type="text" id="add_date_adhesion">
			</div>`);
					break;
				case "etat":
					$('#addInputs').append(`
			<div class="mb-3 me-2">
				<label class="form-label">Description</label>
				<input type="text" id="add_description">
			</div>`);
					break;

				case "commune":
					$('#addInputs').append(`
			<div class="mb-3 me-2">
				<label class="form-label">Nom de la commune</label>
				<input type="text" id="add_nom_commune">
			</div>`);
					break;

			}
		}

		function add() {
			let data;
			let table = $('#baseSelect').val();

			switch (table) {
				case "emprunt":
					data = JSON.stringify({
						"KILOMETRAGE_DEPART": $("#add_kilometrage_depart").val(),
						"HEURE_DEPART": $("#add_heure_depart").val(),
						"HEURE_RENDU": $("#add_heure_rendu").val(),
						"ID_ADHERENT": $("#add_id_adherent").val(),
						"ID_STATION": $("#add_id_station").val(),
						"ID_VELO": $("#add_id_velo").val(),
					});
					break;

				case "velo":
					data = JSON.stringify({
						"MARQUE": $("#add_marque").val(),
						"DATE_MISE_EN_SERVICE": $("#add_edate_mise_en_service").val(),
						"KILOMETRAGE": $("#add_kilometrage").val(),
						"ETAT": $("#add_etat").val(),
						"NIVEAU_BATTERIE": $("#add_niveau_batterie").val(),
						"ID_STATION": $("#add_id_station").val(),
					});
					break;

				case "station":
					data = JSON.stringify({
						"ADRESSE": $("#add_adresse").val(),
						"COMMUNE": $("#add_commune").val(),
						"NB_BORNES": $("#add_nb_bornes").val(),
						"NB_BORNES_DISPO": $("#add_nb_bornes_dispo").val(),
					});
					break;

				case "adherent":
					data = JSON.stringify({
						"NOM": $("#add_nom").val(),
						"ADRESSE": $("#add_adresse").val(),
						"COMMUNE": $("#add_commune").val(),
						"DATE_ADHESION": $("#add_date_adhesion").val(),
					});
					break;

				case "etat":
					data = JSON.stringify({
						"DESCRIPTION": $("#add_description").val(),
					});
					break;

				case "commune":
					data = JSON.stringify({
						"NOM_COMMUNE": $("#add_nom_commune").val(),
					});
					break;
			}


			postApi(data, table, "add")
		}

		function postApi(data, table, action) {

			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function () {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
					console.log(xmlHttp.response);
				}
			}
			xmlHttp.open("POST", "/api/" + table + "/" + action, true);
			xmlHttp.setRequestHeader('Content-Type', 'application/json');
			xmlHttp.send(data);
		}

		// ##### GET #####
		let getTable;

		$(document).ready(function () {
		});

		function getApi(api) {
			getTable = api;
			sendRequest("/api/" + getTable, "GET", displayApi);
		}

		function displayApi(result) {
			insertHeader(result);
			insertBody(result);
		}

		function insertHeader(result) {
			table.destroy();
			$("#apiResultHead").empty();

			let keys = Object.keys(result[0]);
			for (let key of keys) {
				$("#apiResultHead").append('<th scope="col">' + key + ' </th>');
			}
			$("#apiResultHead").append('<th scope="col">Actions</th>');
		}

		function deleteApi(table, key, value) {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function () {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
					console.log(xmlHttp.response);
				}
			}
			xmlHttp.open("DELETE", "/api/" + table + "/" + key + "/" + value, true);
			xmlHttp.setRequestHeader('Content-Type', 'application/json');
			xmlHttp.send();
		}

		function removeRow(element) {
			data = table.row($(element).parents('tr')).data();
			let key;
			let value;

			switch (getTable) {
				case "adherent":
					key = "ID_ADHERENT";
					value = data[4];
					break;
				case "commune":
					key = "ID_COMMUNE";
					value = data[1];
					break;
				case "emprunt":
					key = "ID_EMPRUNT";
					value = data[5];
					break;
				case "station":
					key = "ID_STATION";
					value = data[4];
					break;
				case "velo":
					key = "ID_VELO";
					value = data[6];
					break;
			}
			deleteApi(getTable, key, value);
			table.row($(element).parents('tr')).remove().draw();
		}

		function editRow(element) {
			let data = table.row($(element).parents('tr')).data();

			let columnsNames = $("#apiResultHead").children();

			for (let i = 0; i < columnsNames.length -1; ++i) {
				
				$("#editionContainer").append( $(columnsNames[i]).text());

			}
			

		}

		function insertBody(result) {
			$("#apiResultBody").empty();
			table = $('#tableGetResults').DataTable({
				"columnDefs": [{
					"targets": -1,
					"data": null,
					"defaultContent": `<div class="d-flex">
											<button onclick="editRow(this)">EDIT</button>
											<button onclick="removeRow(this);">REMOVE</button>
										</div>`
				}]
			});

			for (let row of result) {
				let data = []
				for (let key in row) {
					data.push(row[key]);
				}
				table.row.add(data).draw();
			}
		}

		function sendRequest(url, method, callback) {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function () {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
					callback(JSON.parse(xmlHttp.response));
				}
			}
			xmlHttp.open(method, url, true);
			xmlHttp.send();
		}


		function send() {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function () {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
					console.log(xmlHttp.response);
				}
			}
			xmlHttp.open("GET", "/api", true);
			xmlHttp.send();
		}
	</script>
</body>

</html>